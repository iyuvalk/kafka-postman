#!/bin/bash

FILE=$(realpath "$0")
FOLDER=$(dirname "$FILE")
VERSION=$(cat "$FOLDER/VERSION.json" | jq -r ".docker_image")
MAJOR=$(echo $VERSION | cut -d. -f1)
MINOR=$(echo $VERSION | cut -d. -f2)
REV=$(echo $VERSION | cut -d. -f3)
REV=$(( REV + 1 ))
DATE=$(date +%s)
NEW_VERSION="${MAJOR}.${MINOR}.${REV}.${DATE}"
MAX_RETRIES=50
if [[ "$1" == "--force" ]]; then
  FORCE="1"
fi

cd "$FOLDER"
echo "[$(date --iso=seconds)][INFO] Getting old version's hash..."
find "$FOLDER/bin" -type f -exec md5sum {} \; | sort
OLD_VER_HASH=$(find "$FOLDER/bin" -type f -exec md5sum {} \; | sort | md5sum | awk '{print $1}')
echo "[$(date --iso=seconds)][INFO] Trying to compile the code..."
if go build -o "$FOLDER/bin/kafka-postman/kafka-postman"; then
  echo "[$(date --iso=seconds)][INFO] Getting new version hash..."
  find "$FOLDER/bin" -type f -exec md5sum {} \; | sort
  NEW_VER_HASH=$(find "$FOLDER/bin" -type f -exec md5sum {} \; | sort | md5sum | awk '{print $1}')
  if [[ "$NEW_VER_HASH" == "$OLD_VER_HASH" ]] && [[ "$FORCE" -ne "1" ]]; then
    echo "[$(date --iso=seconds)][INFO] The new version has not changed. Assuming that only the tests have changed."
    BIN_CHANGE_DETECTED=0
  else
    echo "[$(date --iso=seconds)][INFO] The new version has changed (or --force was used). Updating the version file..."
    BIN_CHANGE_DETECTED=1
    echo "[$(date --iso=seconds)][INFO] Updating version number..."
    echo \
    '//NOTE: This file is automatically generated by '"$FILE"'
    package main

    func GetMyVersion() string {
    	return "v'"$NEW_VERSION"'"
    }'>"version.go"

    # Rebuilding with the new version
    echo "[$(date --iso=seconds)][INFO] Building the code..."
    go build -o "$FOLDER/bin/kafka-postman/kafka-postman"
    cat "$FOLDER/VERSION.json" | jq '.docker_image |= "'"$NEW_VERSION"'"' > "$FOLDER/VERSION.json.tmp"
    mv "$FOLDER/VERSION.json.tmp" "$FOLDER/VERSION.json"

    echo "[$(date --iso=seconds)][INFO] Building the docker image of the current version and tagging it..."
    cd "$FOLDER/bin/kafka-postman"
    docker build . -t kafka-postman:$NEW_VERSION -t kafka-postman:latest
  fi
  echo "[$(date --iso=seconds)][INFO] Starting automated tests sequence..."
  [ -d "$FOLDER/tests" ] && cd "$FOLDER/tests" || echo "A tests folder could not be located. Cannot run automated tests"
  TEST_FOLDERS=$(find . -maxdepth 1 -type d -name "test_*")
  for test_folder in $TEST_FOLDERS; do
    FOLDER_NAME=$(basename "$test_folder")
    echo "Verifying that the test folder $test_folder is properly constructed..."
    TEST_FILES=$(find "$test_folder/" -maxdepth 1 -executable -type f -name "test*.sh")
    TEST_FILES_COUNT=$(echo -e "$TEST_FILES" | grep -v '^\s*$' | wc -l)
    if [ "$TEST_FILES_COUNT" -gt 0 ]; then
      echo "[$(date --iso=seconds)][INFO] It is. Running the init.sh script to prepare for the tests in the $test_folder folder..."
      if [ -x "$test_folder/init.sh" ]; then
        echo "[$(date --iso=seconds)][INFO] Initializing the test in the folder $test_folder..."
        "$test_folder/init.sh" "$test_folder" | sed -e 's/^/\['"$(date --iso=seconds)"'][INFO]['"$FOLDER_NAME"'\][INIT   ] /'
      fi
      for test_file in $TEST_FILES; do
        TEST_STATUS=9999
        RETRIES=$MAX_RETRIES
        while [ $TEST_STATUS -gt 0 ] && [ $RETRIES -gt 0 ]; do
          echo "[$(date --iso=seconds)][INFO] Running the test $test_file from folder $test_folder..."
          TEST_RES=$("$test_file" "$test_folder")
          TEST_STATUS=$?
          echo -e "$TEST_RES" | sed -e 's/^/\['"$(date --iso=seconds)"'][INFO]['"$FOLDER_NAME"'\][TEST   ] /'
          if [ $TEST_STATUS -eq 0 ]; then
            echo "[$(date --iso=seconds)][INFO] Test $test_file succeeded ($RETRIES retries left). Cleaning up and continuing..."
            break
          else
            if [ $RETRIES -gt 0 ]; then
              echo "[$(date --iso=seconds)][INFO] Test $test_folder FAILED ($RETRIES retries left). Waiting 5 seconds and retrying..."
              sleep 5s
            else
              echo "[$(date --iso=seconds)][INFO] Test $test_folder FAILED ($RETRIES retries left). Leaving everything UNCLEAN to help debug this... (You can clean it up by running \"$(realpath $test_folder)/cleanup.sh\" \"$(realpath $test_folder)\")"
              exit 9
            fi
          fi
          (( RETRIES-- ))
          if [ $RETRIES -eq 0 ] && [ $TEST_STATUS -gt 0 ]; then
            echo "[$(date --iso=seconds)][INFO] Test $test_folder FAILED ($RETRIES retries left). Leaving everything UNCLEAN to help debug this... (You can clean it up by running \"$(realpath $test_folder)/cleanup.sh\" \"$(realpath $test_folder)\")"
            exit 9
          fi
        done
      done
      if [ -x "$test_folder/cleanup.sh" ]; then
        echo "[$(date --iso=seconds)][INFO] Cleaning up the test resources for the test in folder $test_folder..."
        "$test_folder/cleanup.sh" "$test_folder" | sed -e 's/^/\['"$(date --iso=seconds)"'][INFO]['"$FOLDER_NAME"'\][CLEANUP] /'
        echo "[$(date --iso=seconds)][INFO] Waiting after cleanup for 10 seconds..."
        sleep 10s
      fi
    else
      echo '+WARN: Folder '"$test_folder"' does not contain any executable files named "test*.sh". SKIPPING'
    fi
  done
  if [[ "$BIN_CHANGE_DETECTED" == 1 ]] || [[ "$FORCE" == "1" ]]; then
    echo "[$(date --iso=seconds)][INFO] All tests ran successfully. Docker image at version $NEW_VERSION is available locally. Tagging the new image"
    IMAGE_ID=$(docker image ls | grep -E '^kafka-postman\s+'"$NEW_VERSION" | awk '{print $3}')
    docker tag $IMAGE_ID artifexil/kafka-postman:$NEW_VERSION
    docker tag $IMAGE_ID artifexil/kafka-postman:latest
  else
    echo "[$(date --iso=seconds)][INFO] All tests ran successfully. Done."
  fi
fi
